import{ToastGenerator}from"./ToastGenerator.min.js";import{CalloutGenerator}from"./CalloutGenerator.min.js";import{ApiService}from"./ApiService.min.js";class DataTableManager{static DEFAULT_LANGUAGE_URL={fileLanguage:"fr_FR",exclude:["select"]};static DEFAULT_ORDER=[0,"desc"];static DEFAULT_RESPONSIVE=!0;static DEFAULT_PAGE_LENGTH=10;static DEFAULT_LENGTH_MENU=[[10,25,50,100,-1],[10,25,50,100,"Tous"]];static DEFAULT_HEAD=[];static DEFAULT_PAGING_TYPE="_numbers";static DEFAULT_SELECTABLE=!1;static DEFAULT_BUTTONS=[{extend:"copy",text:"Copier",className:"btn-sm btn-main"},{extend:"excel",text:"XLSX",className:"btn-sm btn-main"},{extend:"csv",text:"CSV",className:"btn-sm btn-main"},{extend:"pdf",text:"PDF",className:"btn-sm btn-main"},{extend:"print",text:"Imprimer",className:"btn-sm btn-main"}];static DEFAULT_TABLE_CLASS="table-striped w-100";static DEFAULT_BTN_CLASS="btn-sm btn-primary";static DEFAULT_DOM=['<"d-flex flex-column flex-md-row justify-content-between gap-2 w-100 py-2"<"text-light my-auto"l><"text-light my-auto"f>><"container-fluid overflow-scroll text-light mb-3 p-0 w-100"t><"d-flex flex-column flex-lg-row justify-content-between gap-2 mb-3"<"text-light"i><""p>>','<"d-flex flex-column flex-lg-row justify-content-between w-100 py-2"Bl><"container-fluid overflow-auto p-0"t><"d-flex flex-column flex-lg-row justify-content-between mb-3 text-light"ip>'];static DEFAULT_DOM_NO_BUTTONS=['<"d-flex flex-column flex-lg-row justify-content-between py-2"<"mx-auto text-light"l>><"table-responsive p-0"t><"d-flex flex-column flex-lg-row justify-content-between mb-3 text-light"ip>'];constructor(a,e={}){this.toastGenerator=new ToastGenerator,this.calloutGenerator=new CalloutGenerator,this.apiService=new ApiService,this.tableElement=$("#"+a),this.params={language:e.language??DataTableManager.DEFAULT_LANGUAGE_URL,order:e.order??DataTableManager.DEFAULT_ORDER,responsive:e.responsive??DataTableManager.DEFAULT_RESPONSIVE,pageLength:e.pageLength??DataTableManager.DEFAULT_PAGE_LENGTH,lengthMenu:e.lengthMenu??DataTableManager.DEFAULT_LENGTH_MENU,headSearch:e.headSearch??DataTableManager.DEFAULT_HEAD,pagingType:e.pagingType??DataTableManager.DEFAULT_PAGING_TYPE,select:e.select??DataTableManager.DEFAULT_SELECTABLE,buttons:e.buttons??DataTableManager.DEFAULT_BUTTONS,tableClass:e.tableClass??DataTableManager.DEFAULT_TABLE_CLASS,btnClass:e.btnClass??DataTableManager.DEFAULT_BTN_CLASS,domPatternIndex:e.domPatternIndex??0,columns:e.columns??[],searchCols:e.searchCols??[],serverSide:e.serverSide??!1,ajaxEndPoint:e.endpoint??"process.php",ajaxParams:e.ajaxParams??{type:"GET",dataType:"json",options:{}},onInitComplete:e.onInitComplete??null,onHeaderCallback:e.onHeaderCallback??null,onCreatedRow:e.onCreatedRow??null,onXHR:e.onXHR??null,onSelect:e.onSelect??null,onDeselect:e.onDeselect??null},this.init()}init(){var a;$.fn.dataTable.isDataTable(this.tableElement)||(a=`/assets/libs/datatables/translate/${this.params.language.fileLanguage}.json`,this.loadTranslations(a).then(a=>{a=this.filterTranslations(a,Object.keys(a),this.params.language.exclude);this.initializeDataTable(a)}))}initializeDataTable(a){var e=this.params.buttons&&0<this.params.buttons.length?DataTableManager.DEFAULT_DOM[this.params.domPatternIndex]??DataTableManager.DEFAULT_DOM[0]:DataTableManager.DEFAULT_DOM_NO_BUTTONS[this.params.domPatternIndex]??DataTableManager.DEFAULT_DOM_NO_BUTTONS[0];let t=this.tableElement.DataTable({dom:e,buttons:this.params.buttons,language:a,stateSave:!0,order:this.params.order,responsive:this.params.responsive,pageLength:this.params.pageLength,lengthMenu:this.params.lengthMenu,pagingType:this.params.pagingType,select:this.params.select,columns:this.params.columns,searchCols:this.params.searchCols,processing:this.params.serverSide,serverSide:this.params.serverSide,ajax:this.params.serverSide?this.ajaxFunction.bind(this):null,initComplete:this.initComplete.bind(this),headerCallback:this.headerCallback.bind(this),createdRow:this.createdRow.bind(this)});this.tableElement.on("select.dt",(a,e,t,s)=>{"function"==typeof this.params.onSelect&&this.params.onSelect(a,e,t,s)}),this.tableElement.on("deselect.dt",(a,e,t,s)=>{"function"==typeof this.params.onDeselect&&this.params.onDeselect(a,e,t,s)}),!this.params.serverSide&&this.params.searchCols.length&&this.params.searchCols.forEach((a,e)=>{a&&a.search&&t.column(e).search(a.search).draw()})}initComplete(){let t=this.tableElement.DataTable();this.params.btnClass&&$(".dt-buttons .btn").each(function(){$(this).removeClass("btn-secondary").addClass(this.params.btnClass)}),this.params.tableClass&&this.tableElement.addClass(this.params.tableClass),Array.isArray(this.params.headSearch)&&t.columns().every(t=>{if(this.params.headSearch.includes(t)){let a=this;t=a.header().textContent;let e=document.createElement("input");e.placeholder=t,e.classList.add("w-100"),a.header().append(e),e.addEventListener("keyup",()=>{a.search()!==e.value&&a.search(e.value).draw()})}}),this.params.searchCols.length&&this.params.searchCols.forEach((a,e)=>{a&&a.search&&t.column(e).search(a.search).draw()}),"function"==typeof this.params.onInitComplete&&this.params.onInitComplete(t)}async loadTranslations(a){try{return await $.getJSON(a)}catch(a){return this.calloutGenerator.createCallout("Échec lors du chargement de la traduction:"+a),{}}}async ajaxFunction(a,e){try{var t=await this.apiService.get(this.params.ajaxEndPoint,{data:a,headers:{"Content-Type":"application/json"},dataType:this.params.ajaxParams.dataType});e(t),"function"==typeof this.params.onXHR&&this.params.onXHR(t)}catch(a){throw this.calloutGenerator.createCallout("Échec lors de la requête: "+a),a}}headerCallback(a,e,t,s,n){"function"==typeof this.params.onHeaderCallback&&this.params.onHeaderCallback(a,e,t,s,n)}createdRow(a,e,t){"function"==typeof this.params.onCreatedRow&&this.params.onCreatedRow(a,e,t)}reloadTable(){this.tableElement&&this.tableElement.DataTable().ajax.reload(null,!1)}filterTranslations(e,a,t){let n={};return Object.keys(e).forEach(a=>{t.includes(a)?n[a]="":"object"!=typeof e[a]||Array.isArray(e[a])?void 0!==e[a]&&(n[a]=e[a]):n[a]=this.filterTranslations(e[a],Object.keys(e[a]),t)}),t.forEach(a=>{let t=a.split("."),s=n;t.forEach((a,e)=>{e===t.length-1?s[a]="":(s[a]=s[a]||{},s=s[a])})}),n}}export{DataTableManager};